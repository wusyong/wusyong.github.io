<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <meta content="#ffffff" name="theme-color" />
  <meta content="#da532c" name="msapplication-TileColor" />

  
  
  
  
  

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.css" integrity="sha384-+rY0QD+LRnTOquDMzGa9lXU6jIwdiQuwCJQ2cdcW0qeP/0UbjQCZlXnRsUMA+9pH" crossorigin="anonymous">
  

  

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.1/css/academicons.min.css" integrity="sha384-FIue+PI4SsI9XfHCz8dBLg33b0c1fMJgNU3X//L26FYbGnlSEfWmNT7zgWc2N9b6" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link href="https://wusyong.github.io/deep-thought.css" rel="stylesheet" />
  
  

  <title>
    
 | 你想要多安全的記憶體安全？

  </title>

  
  
  

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css" integrity="sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js" integrity="sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx" crossorigin="anonymous"></script>

  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/mathtex-script-type.min.js" integrity="sha384-jiBVvJ8NGGj5n7kJaiWwWp9AjC+Yh8rhZY3GtAX8yU28azcLgoRo4oukO87g7zDT" crossorigin="anonymous"></script>
  
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
  
  
</head>

<body class="has-background-white">
  <nav aria-label="section navigation" class="navbar is-light" role="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item is-size-5 has-text-weight-bold" href="https:&#x2F;&#x2F;wusyong.github.io&#x2F;"></a>
        <a aria-expanded="false" aria-label="menu" class="navbar-burger burger" data-target="navMenu" role="button">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu" id="navMenu">
        <div class="navbar-end has-text-centered">
          
          
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;wusyong.github.io&#x2F;&#x2F;">
            Home
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;wusyong.github.io&#x2F;&#x2F;posts">
            Posts
          </a>
          
          
          
          <a class="navbar-item" id="nav-search" title="Search" data-target="#search-modal">
            <span class="icon">
              <i class="fas fa-search"></i>
            </span>
          </a>
          <a class="navbar-item" id="dark-mode" title="Switch to dark theme">
            <span class="icon">
              <i class="fas fa-adjust"></i>
            </span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  
  

  
<section class="section">
  <div class="container">
    <div class="columns">
      <div class="column is-8 is-offset-2">
        <article class="box">
          <h1 class="title">
            你想要多安全的記憶體安全？
          </h1>
          <p class="subtitle"></p>
          <div class="columns is-multiline is-gapless">
            <div class="column is-8">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="fas fa-user"></i>
  </span>
  <span>Wu Yu Wei published on</span>
  <span class="icon">
    <i class="far fa-calendar-alt"></i>
  </span>
  <span><time datetime="2022-02-13T12:04:23+08:00">February 13, 2022</time></span>
</span>

            </div>
            <div class="column is-4 has-text-right-desktop">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="far fa-clock"></i>
  </span>
  <span>11 min,</span>
  <span class="icon">
    <i class="fas fa-pencil-alt"></i>
  </span>
  <span>2096 words</span>
</span>

            </div>
            <div class="column">
              
            </div>
            <div class="column has-text-right-desktop">
              
            </div>
          </div>
          <div class="content mt-2">
            <p><strong>記憶體安全</strong>通常是指針對軟體在處理記憶體存取時的措施手段，像是防止 Buffer Overflow 或 Dangling Pointer 等等。大多數擁有 Garbage Collection 的語言會在 Runtime 自動幫忙管理記憶體，而且不會暴露出太危險的抽象化型別給使用者直接使用。但在 C 和 C艹 則允許在沒有任何防護或檢查下，直接使用指標直接操控記憶體位置，我們通常就會稱這些語言是<strong>記憶體不安全的語言</strong>。</p>
<h2 id="wei-he-wo-men-xu-yao-tao-lun-ji-yi-ti-an-quan">為何我們需要討論記憶體安全?</h2>
<p>我們之所以一而再再而三地討論並思考記憶體安全性的問題，無非是因為仍有非常多的軟體程式仍然是用記憶體不安全的語言寫出來的，且很多仍得繼續使用而造成維護的困難。這些很多是效能敏感的程式，無法負擔 Garbage Collector 在 Runtime 上產生的開銷。抑或是歷史的包袱，複雜的架構已經無法再改用其他語言重寫或維護。</p>
<p>當我們仔細分析像是 <a href="https://langui.sh/2019/07/23/apple-memory-safety/">iOS/macOS</a>、<a href="https://security.googleblog.com/2019/05/queue-hardening-enhancements.html">Android</a>、<a href="https://msrc-blog.microsoft.com/2019/07/18/we-need-a-safer-systems-programming-language/">Windows</a>、<a href="https://daniel.haxx.se/blog/2021/03/09/half-of-curls-vulnerabilities-are-c-mistakes/">cURL</a> 這些重要的專案，我們可以發現所有專案的 CVE 有 60 ~ 90% 全都是來自記憶體安全相關的錯誤。用比較負面的觀點來說的話，也就是會有這些記憶體安全的錯誤全都只是因為用了 C 和 C艹 來寫。</p>
<p>不過當然隨著時代在進步，C 和 C艹 的生態系也出現不少檢查工具鏈來改善，除了 Valgrind 能用來檢查記憶體洩漏，其他還有像是 AddressSanitizor、ThreadSanitizor 能來分別檢查記憶體位址與執行緒的安全。上面分析 iOS/macOS 的文章就可以看到，記憶體安全的錯誤比例有逐年遞減到約略 60% 左右。</p>
<p>但能視為通用程式語言並用在系統開發上的語言當然不是只有 C 和 C艹 而已。早在 1980 年就已經有 Ada 語言存在，並廣泛運用在美軍的系統程式上。而甚至有人開發過 Lisp 機器嘗試將 Lisp 作為該電腦的主要開發語言。</p>
<p>而近年來還有許多新興的程式語言能選擇，有些承襲了些傳統語言預設會去做的檢查並在編譯時就做好優化，有些甚至帶來了有趣的概念像是 Rust 的<strong>所有權與 Borrow Checker</strong> 來治本解決根本性的問題。許多諸如 <a href="https://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git/commit/rust?id=c77c8025525c36c9d2b9d82e4539403701276a1d">Linux</a> 的 Kernal Module、Amazon 的虛擬化技術 <a href="https://firecracker-microvm.github.io/">Firecracker</a>、Google 的 <a href="https://security.googleblog.com/2021/04/rust-in-android-platform.html">Android</a> 與 <a href="https://security.googleblog.com/2021/09/an-update-on-memory-safety-in-chrome.html">Chrome</a> 甚至是 <a href="https://fuchsia.dev/fuchsia-src/development/languages/rust">Fuchsia</a> 以及 <a href="https://github.com/microsoft/windows-rs">Windows</a>，這些大型企業以及開源的專案都開始嘗試使用 Rust 來寫。</p>
<h2 id="na-gai-xuan-ze-na-xie-ji-yi-ti-an-quan-yu-yan">那該選擇哪些記憶體安全語言?</h2>
<p>所有具有 Garbage Collection 的語言都算是記憶體安全的語言，盡管在執行時會有一定程度的開銷，但是它們可沒有想像中的那麼笨重緩慢不堪。JVM 和 .NET 都有十分強而有力的 Garbage Collector 實作，如果無法完全理解記憶體與抽象指標的概念，或是手動的記憶體管理反而是負擔的話，仍然非常推薦有 Garbage Collection 的語言像是 Elixir、F# 和 Racket 等等。</p>
<p>但很多時候不如在一開始就搞定問題，Garbage Collector 產生問題時要解決的時間與人力成本也不亞於非記憶體安全的語言，最常見就像 Java 的記憶體卡在老生代釋放不掉造成 Out of Memeory，且並行程式下也可能防止不了 Data Race。在 Oracle 和 Line 等企業中都得培養整個部門團隊去維護優化它們的 JVM。</p>
<p>回到不用 Garbage Collection 的語言，像是 C 和 C艹 也不是都沒在做檢查，除了上述提到的檢查工具，也有許多標準規範像是 MISRA C 來限制。不過這些畢竟不全是預設行為，對自己的要求標準高，其他的開發者或團隊可能並沒有跟你站在同個標準上。所以使用 Ada 和 Zig 這些預設在編譯時就會做諸多記憶體安全檢查的語言會是我推薦的選項。在先不討論 Allocator 的情況下，要在 Zig 做記憶體不安全的行為是要明確指定的，從 Build Mode 就可以略知該程式提供的保障到哪。</p>
<p>接下來我們還有 Rust，所有權和 Borrow Checker 能在編譯時釐清記憶體的歸屬問題，任何人都能夠寫出既迅速又安全的程式碼，讓魚與熊掌可以兼得。而所有權當然其實和 C艹 的 RAII 類似，且 Borrow Checker 在做的也是我們平時在寫程式時腦海裡就會勾勒出的藍圖。然而讓編譯器也一同檢查比你自己一個人檢查更清楚多了，有許多專案重寫後還發現原來沒找出的 bug。</p>
<h2 id="zhe-xie-yu-yan-you-duo-an-quan">這些語言有多安全?</h2>
<p>最後我想我們可以來看看上述的語言相比到底多安全。確實使用 C 夠謹慎的話，的確能一掃所有記憶體安全問題。寫 Rust 使用 <code>unsafe</code> 也能把 Undefined Behaviour 玩得天花亂墜。但我們想知道在預設行為下，這些語言到底提供了怎麼樣的保障。Garbage Collection 的語言不用說，本文提到的多數問題應該都不必煩惱。至於 C、Zig 與 Rust 相比的話，我們有以下 <a href="https://www.scattered-thoughts.net/writing/how-safe-is-zig/">Jamie Brandon</a> 整理的列表:</p>
<table><thead><tr><th>問題</th><th>C</th><th>Zig</th><th>Rust</th></tr></thead><tbody>
<tr><td>Out-of-Bounds Heap Read/Write</td><td>❌</td><td>⭕️</td><td>⭕️</td></tr>
<tr><td>Null Pointer Dereference</td><td>❌</td><td>⭕️¹</td><td>⭕️¹</td></tr>
<tr><td>Type Confusion</td><td>❌</td><td>⭕️²</td><td>⭕️</td></tr>
<tr><td>Integer Overflow</td><td>❌</td><td>⭕️</td><td>❌³</td></tr>
<tr><td>Use After Free</td><td>❌</td><td>❌⁴</td><td>⭕️</td></tr>
<tr><td>Double Free</td><td>❌</td><td>❌⁴</td><td>⭕️</td></tr>
<tr><td>Invalid Stack Read/Write</td><td>❌</td><td>❌</td><td>⭕️</td></tr>
<tr><td>Uninitialized Memory</td><td>❌</td><td>❌⁵</td><td>⭕️</td></tr>
<tr><td>Data Race</td><td>❌</td><td>❌</td><td>⭕️⁶</td></tr>
</tbody></table>
<p>上面的列表我有更改一些，以確定真的都是預設的行為。在 Zig 我們討論的是 <code>Debug</code> / <code>ReleaseSafe</code> Mode，而 Rust 則是 <code>Debug</code> / <code>Release</code> Profile。而有附上數字的欄位就是接下來需要近一步解釋，或是某方面其實還是能視為安全的地方：</p>
<ol>
<li>
<p>其實就是提供 <code>Option</code> 型別作為第一公民。</p>
</li>
<li>
<p>只有 Union 會造成<a href="https://cwe.mitre.org/data/definitions/843.html">型別混淆</a>，雖然 Zig 可以用 <code>enum</code> 組合成 Tagged Union，但這必免不了持有指標數值的同時更改 Tag。</p>
</li>
<li>
<p>在 <code>Debug</code> 時 Overflow 會 Panic，在 <code>Release</code> 則是會 Wrap。實際在做數值運算時通常都是使用型別提供的方法像是 <code>wrapping_add</code> 或 <code>overflow_add</code> 來確定想要的行為。</p>
</li>
<li>
<p>Zig 的作者 <a href="https://lobste.rs/s/v5y4jb/how_safe_is_zig#c_vddk9j">Andrew Kelley</a> 有解釋其標準函式庫提供的 Allocator 會防止這些常見的記憶體分配錯誤。C 也有像是 <a href="https://github.com/GrapheneOS/hardened_malloc">hardened_malloc</a> 的概念，不過並沒有什麼標準函式庫，預設就能拿來使用。</p>
</li>
<li>
<p>Zig 的安全檢查會檢測未初始化的記憶體，且使用的關鍵字是 <code>undefined</code>。在 <code>Debug</code> 時寫入的值是 0xaa 以方便做檢查。</p>
</li>
<li>
<p>所有權和 Borrow Checker 能完全杜絕 Data Race，我發現這是很少被提到的，在有些 Garbage Collection 的語言甚至沒有辦法完全防範。</p>
</li>
</ol>
<p>最後有一些問題並沒有列上去，因為這在所有語言都存在，而且有時候是刻意為之的：</p>
<ul>
<li>
<p>Race Condition：因為整個系統本質上就在互相爭奪資源的寫入與讀取，當程式需要依賴這些系統進行操作的話，難免會在非常極端的狀況出現微妙的問題，而且有時是非常難以重現的，這個我覺得值得獨立一個話題討論。</p>
</li>
<li>
<p>Memory Leak：記憶體洩漏不像其他行為會觸發到 Undefined Behaviour 進而造成程式錯誤，而且有時候是刻意洩漏的。在 Valgrind 的檢查中洩漏就被分成好幾種類別，有些其實使用者自己知道且仍在掌控中。</p>
</li>
</ul>

          </div>
        </article>
      </div>
      
    </div>
  </div>
</section>


  
  <section class="modal" id="search-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Search</p>
      </header>
      <section class="modal-card-body">
        <div class="field mb-2">
          <div class="control">
            <input class="input" id="search" placeholder="Search this website." type="search" />
          </div>
        </div>
        <div class="search-results">
          <div class="search-results__items"></div>
        </div>
      </section>
    </div>
    <button aria-label="close" class="modal-close is-large"></button>
  </section>
  


  

<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <nav class="level">
              
          <div class="level-item has-text-centered">
            <a class="button is-black is-outlined" href="https:&#x2F;&#x2F;wusyong.github.io&#x2F;posts&#x2F;fn&#x2F;">
              <span class="icon mr-2">
                <i class="fas fa-arrow-circle-left"></i>
              </span>
              fn 與 Fn
            </a>
          </div>
           
          <div class="level-item has-text-centered">
            <a class="button is-black is-outlined" href="https:&#x2F;&#x2F;wusyong.github.io&#x2F;posts&#x2F;mutex&#x2F;">
              Mutex 的大小<span class="icon ml-2">
                <i class="fas fa-arrow-circle-right"></i>
              </span>
            </a>
          </div>
          
        </nav>
      </div>
    </div>
  </div>
</section>



  



  
  <footer class="footer py-4">
    <div class="content has-text-centered">
      <p>
        Built with
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-code"></i>
          </span>
          <span>code</span>
        </span>
        and
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-heart"></i>
          </span>
          <span>love</span>
        </span>
      </p>
      <p>
        Powered by
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-power-off"></i>
          </span>
          <span>zola</span>
        </span>
      </p>
    </div>
  </footer>
  

  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/galleria.min.js" integrity="sha384-QSfwGT8/EU536DKdtyP2D6SLlh8zBaZ0cVkwfrwhqzIU9VCfJT00CLVP5t+HAiYg" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.js" integrity="sha384-DwpKI+deZB267+hPKwiOIc5Y2GKsVL0mR6hgz7GgIu7AgAMYqJwcJKY1YBNfhWcY" crossorigin="anonymous"></script>
  
  
  <script src="https://cdn.jsdelivr.net/npm/mermaid@8.13.5/dist/mermaid.min.js" integrity="sha384-0yWn54pSGtfKCU+skfA69l25VsCw+MZt4LQov3xNRoS7YkAMrFokGgSBnAWSK4pv" crossorigin="anonymous"></script>
  
  
  <script src="https://cdn.jsdelivr.net/npm/chart.xkcd@1.1.13/dist/chart.xkcd.min.js" integrity="sha384-xC3h1+IHXK8seA+8KfT79Z4e0GPsznjXBoMa5nd8ooWKplPyXx92NOmljWxLC/cs" crossorigin="anonymous"></script>
  
  
  <script src="https://wusyong.github.io/elasticlunr.min.js"></script>
  <script src="https://wusyong.github.io/search_index.en.js"></script><script src="https://wusyong.github.io/js/site.js"></script>

  





  
  
</body>

</html>
